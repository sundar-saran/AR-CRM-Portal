@using CRM_Buddies_Task.Models
@{
    var roleId = (int?)Session["RoleId"] ?? 0;
    string fullName = ViewBag.FullName as string ?? "User";
    var menus = ViewBag.Menus as List<MenuItem> ?? new List<MenuItem>();
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>@ViewBag.Title - AR-CRM Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/3.2.12/jquery.validate.unobtrusive.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

    <script src="~/Scripts/jquery-3.6.0.min.js"></script>
    <script src="~/Scripts/jquery.validate.min.js"></script>
    <script src="~/Scripts/jquery.validate.unobtrusive.min.js"></script>

    @RenderSection("Styles", required: false)

<style>
        body {
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        #main-content {
            transition: margin-left 0.3s ease, font-family 0.3s ease, font-size 0.3s ease;
        }

        .theme-sensitive-text {
            color: #ffffff;
        }

        body.light-theme .theme-sensitive-text {
            color: #000000 !important;
        }

        body.dark-theme {
            background: #1c1c1e;
            color: #ffffff;
        }

        body.light-theme {
            background: #f8f9fa;
            color: #212529;
        }

        body:not(.dark-theme):not(.light-theme) {
            opacity: 0;
            visibility: hidden;
        }

        body.dark-theme, body.light-theme {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

    .navbar {
        transition: background-color 0.3s ease, color 0.3s ease;
        z-index: 999;
    }


    body.dark-theme .navbar {
        background-color: #1c1c1e !important;
        color: #ffffff !important;
    }

        body.dark-theme .navbar .navbar-brand,
        body.dark-theme .navbar .navbar-text,
        body.dark-theme .navbar .btn {
            color: #ffffff !important;
        }

    body.light-theme .navbar {
        background-color: #f8f9fa !important;
        color: #212529 !important;
    }

        body.light-theme .navbar .navbar-brand,
        body.light-theme .navbar .navbar-text,
        body.light-theme .navbar .btn {
            color: #212529 !important;
        }


        .navbar-brand i {
            color: #ffd700;
        }



        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            height: 100vh;
            padding-top: 60px;
            overflow-y: auto;
            z-index: 1000;
            transition: all 0.3s ease;
        }

            #sidebar.hidden {
                left: -250px;
            }

        body.dark-theme #sidebar {
            background: rgba(30, 30, 30, 0.95);
            box-shadow: 2px 0 15px rgba(0, 0, 0, 0.7);
        }

        body.light-theme #sidebar {
            background: #ffffff;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        #sidebar h5 {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        body.dark-theme #sidebar h5 {
            color: #ffd700;
        }

        body.light-theme #sidebar h5 {
            color: #0d6efd;
        }

        #sidebar a {
            display: block;
            padding: 15px 20px;
            font-size: 15px;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        body.dark-theme #sidebar a {
            color: #d3d3d3;
        }

        body.light-theme #sidebar a {
            color: #333;
        }

        body.dark-theme #sidebar a:hover {
            background: #292929;
            padding-left: 30px;
            color: #ffd700;
            border-left: 4px solid #ffd700;
        }

    body.light-theme #sidebar a:hover {
        background: #e9ecef;
        padding-left: 30px;
        color: #0d6efd;
        border-left: 4px solid #0d6efd;
    }

        #main-content {
            transition: all 0.3s ease;
            padding: 40px 30px;
            min-height: 100vh;
            margin-left: 250px;
        }

            #main-content.full-width {
                margin-left: 0 !important;
            }

        body.dark-theme #main-content {
            background: #202124;
            color: #ffffff;
        }

        body.light-theme #main-content {
            background: #ffffff;
            color: #000;
        }

        .navbar.with-sidebar {
            margin-left: 250px;
        }

        .navbar.no-sidebar {
            margin-left: 0;
        }

        .logout-link {
            color: #ffd700;
            text-decoration: none;
            font-weight: 600;
            margin-left: 15px;
        }

            .logout-link:hover {
                color: #ffcc00;
                text-decoration: underline;
            }

        .settings-panel {
            position: fixed;
            top: 60px;
            right: -300px;
            width: 300px;
            height: calc(100vh - 60px);
            background-color: #2c2c2e;
            z-index: 1001;
            transition: right 0.3s ease;
            box-shadow: -3px 0 15px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
            padding: 20px;
        }

        body.light-theme .settings-panel {
            background-color: #ffffff;
            box-shadow: -3px 0 10px rgba(0, 0, 0, 0.1);
        }

        .settings-panel.open {
            right: 0;
        }

        .settings-toggle {
            position: fixed;
            top: 70px;
            right: 0;
            z-index: 1002;
            background-color: #ffd700;
            color: #000;
            border: none;
            border-radius: 5px 0 0 5px;
            padding: 10px;
            cursor: pointer;
            transition: right 0.3s ease;
        }

        .settings-panel.open + .settings-toggle {
            right: 300px;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        body.light-theme .settings-header {
            border-bottom: 1px solid #ddd;
        }

        .settings-option {
            margin-bottom: 15px;
        }

            .settings-option label {
                display: block;
                margin-bottom: 5px;
                font-weight: 500;
            }

            .settings-option select, .settings-option input {
                width: 100%;
                padding: 8px;
                border-radius: 5px;
                border: 1px solid #555;
                background-color: #3a3a3c;
                color: #fff;
            }

        body.light-theme .settings-option select,
        body.light-theme .settings-option input {
            border: 1px solid #ccc;
            background-color: #f8f9fa;
            color: #333;
        }

        .settings-footer {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
        }

            .settings-footer button {
                margin-left: 10px;
            }

        @@media (max-width: 768px) {
            #sidebar {
                width: 100%;
                height: auto;
                position: relative;
                left: 0;
            }

            .navbar {
                margin-left: 0 !important;
            }

            #main-content {
                margin-left: 0 !important;
            }

            .settings-panel {
                width: 80%;
                right: -80%;
            }

                .settings-panel.open + .settings-toggle {
                    right: 80%;
                }
        }


        @@media (max-width: 1200px) {
            #sidebar { width: 220px; }
            .navbar.with-sidebar { margin-left: 220px; }
            #main-content { margin-left: 220px; padding: 30px 20px; }
        }

        @@media (max-width: 992px) {
            #sidebar { width: 200px; }
            .navbar.with-sidebar { margin-left: 200px; }
            #main-content { margin-left: 200px; padding: 25px 15px; }
        }

        @@media (max-width: 768px) {
            #sidebar {
                position: fixed;
                top: 56px;
                left: -100%;
                width: 80%;
                max-width: 320px;
                height: calc(100vh - 56px);
                transition: left 0.3s ease;
                z-index: 1200;
                box-shadow: 2px 0 15px rgba(0,0,0,0.5);
            }
            #sidebar.hidden { left: -100% !important; }
            #sidebar:not(.hidden) { left: 0; }

            .navbar.with-sidebar,
            .navbar.no-sidebar,
            #main-content {
                margin-left: 0 !important;
                padding: 20px 12px;
            }

            .settings-panel {
                width: 100%;
                height: 40vh;
                right: 0;
                bottom: -40vh;
                top: auto;
                border-radius: 12px 12px 0 0;
                transition: bottom 0.3s ease;
            }
            .settings-panel.open {
                bottom: 0;
            }

            .settings-toggle {
                top: auto;
                bottom: 15px;
                right: 15px;
                border-radius: 50%;
                padding: 12px 14px;
            }
        }

        @@media (max-width: 576px) {
            #sidebar a {
                padding: 14px 18px;
                font-size: 16px;
            }

            .navbar .navbar-brand { font-size: 1rem; }

            .btn { width: 100%; margin-bottom: 8px; }

            #main-content { padding: 15px 10px; }
        }

        @@media print {
            #sidebar, .navbar, .settings-toggle, .settings-panel { display: none !important; }
            #main-content { margin: 0 !important; padding: 1cm !important; }
        }

</style>
</head>

<body class="dark-theme">

    <div id="sidebar">
        <div class="text-center text-white mb-3">
            <h5><i class="bi bi-person-circle me-1"></i> @fullName</h5>
        </div>
        @foreach (var menu in menus)
        {
            <a href="@menu.MenuUrl">
                <i class="bi bi-chevron-right me-2"></i> @menu.MenuName
            </a>
        }
    </div>

    <nav class="navbar navbar-expand-lg fixed-top with-sidebar theme-sensitive-text">
        <div class="container-fluid">

            <button class="btn btn-outline-light btn-sm me-3" id="sidebarToggle">
                <i class="bi bi-list"></i>
            </button>

            <a class="navbar-brand theme-sensitive-text" href="@Url.Action("Welcome", "Account")">
                <i class="bi bi-box-seam-fill me-1 theme-sensitive-text"></i> AR-CRM Portal
            </a>

            <div class="ms-auto navbar-text theme-sensitive-text">
                Welcome, <strong>@fullName</strong>

                <button id="themeToggle" class="btn btn-outline-warning btn-sm ms-2">
                    <i class="bi bi-sun-fill" id="themeIcon"></i>
                </button>

                @if (Session["UserId"] != null)
                {
                    <a href="@Url.Action("Logout", "Account")" class="btn btn-warning btn-sm rounded-pill ms-2">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </a>
                }
            </div>
        </div>
    </nav>

    <div id="settingsPanel" class="settings-panel theme-sensitive-text">
        <div class="settings-header">
            <h5 class="m-0">Text Settings</h5>
            <button id="closeSettings" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div class="settings-body">

            <div class="settings-option">
                <label for="fontFamily">Font Family</label>
                <select id="fontFamily">
                    <option value="Arial, sans-serif">Arial</option>
                    <option value="'Times New Roman', serif">Times New Roman</option>
                    <option value="'Courier New', monospace">Courier New</option>
                    <option value="Georgia, serif">Georgia</option>
                    <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
                    <option value="Verdana, sans-serif">Verdana</option>
                    <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">Segoe UI</option>
                </select>
            </div>
            <div class="settings-option">
                <label for="fontSize">Font Size</label>
                <select id="fontSize">
                    <option value="14px">Small</option>
                    <option value="16px" selected>Medium</option>
                    <option value="18px">Large</option>
                    <option value="20px">X-Large</option>
                </select>
            </div>
        </div>
        <div class="settings-footer">
            <button id="resetSettings" class="btn btn-secondary btn-sm">Reset</button>
            <button id="applySettings" class="btn btn-primary btn-sm">Apply</button>
        </div>
    </div>

    <button id="settingsToggle" class="settings-toggle">
        <i class="bi bi-gear-fill"></i>
    </button>

    <div id="main-content">
        @RenderBody()
    </div>

    @RenderSection("Scripts", required: false)

    <script>
    (function () {
        try {
            let savedTheme = localStorage.getItem('theme');

            if (!savedTheme) {
                const cookieMatch = document.cookie.match(/theme=([^;]+)/);
                if (cookieMatch && cookieMatch[1]) {
                    savedTheme = cookieMatch[1];
                    localStorage.setItem('theme', savedTheme);
                }
            }

            savedTheme = savedTheme || 'dark';
            document.documentElement.className = savedTheme + '-theme';
        } catch (error) {
            console.error('Error loading theme:', error);
            document.documentElement.className = 'dark-theme';
        }
    })();

    document.addEventListener("DOMContentLoaded", function () {
        const toggleBtn = document.getElementById("themeToggle");
        const themeIcon = document.getElementById("themeIcon");
        const sidebar = document.getElementById("sidebar");
        const sidebarToggle = document.getElementById("sidebarToggle");
        const mainContent = document.getElementById("main-content");
        const navbar = document.querySelector('.navbar');
        const settingsToggle = document.getElementById("settingsToggle");
        const settingsPanel = document.getElementById("settingsPanel");
        const closeSettings = document.getElementById("closeSettings");
        const applySettings = document.getElementById("applySettings");
        const resetSettings = document.getElementById("resetSettings");
        const fontFamily = document.getElementById("fontFamily");
        const fontSize = document.getElementById("fontSize");

        // Theme functions
        function setTheme(theme) {
            try {
                if (theme === "light") {
                    document.body.classList.add("light-theme");
                    document.body.classList.remove("dark-theme");
                    if (themeIcon) {
                        themeIcon.classList.remove("bi-moon-fill");
                        themeIcon.classList.add("bi-sun-fill");
                    }
                } else {
                    document.body.classList.add("dark-theme");
                    document.body.classList.remove("light-theme");
                    if (themeIcon) {
                        themeIcon.classList.remove("bi-sun-fill");
                        themeIcon.classList.add("bi-moon-fill");
                    }
                }

                localStorage.setItem("theme", theme);
                document.cookie = "theme=" + theme + "; path=/; max-age=" + (365 * 24 * 60 * 60);
            } catch (error) {
                console.error('Error setting theme:', error);
            }
        }

        function loadTheme() {
            try {
                let savedTheme = localStorage.getItem("theme");

                if (!savedTheme) {
                    const cookieMatch = document.cookie.match(/theme=([^;]+)/);
                    if (cookieMatch && cookieMatch[1]) {
                        savedTheme = cookieMatch[1];
                        localStorage.setItem("theme", savedTheme);
                    }
                }

                return savedTheme || "dark";
            } catch (error) {
                console.error('Error loading theme:', error);
                return "dark";
            }
        }

        function toggleSettingsPanel() {
            if (settingsPanel) {
                const isOpen = settingsPanel.classList.toggle("open");
                localStorage.setItem("settingsOpen", isOpen ? "true" : "false");
            }
        }

        function applyTextSettings() {
            try {
                const family = fontFamily ? fontFamily.value : "Arial, sans-serif";
                const size = fontSize ? fontSize.value : "16px";

                document.body.style.fontFamily = family;
                document.body.style.fontSize = size;

                if (mainContent) {
                    mainContent.style.fontFamily = family;
                    mainContent.style.fontSize = size;
                }

                localStorage.setItem("fontFamily", family);
                localStorage.setItem("fontSize", size);

                document.cookie = "fontFamily=" + family + "; path=/; max-age=" + (365 * 24 * 60 * 60);
                document.cookie = "fontSize=" + size + "; path=/; max-age=" + (365 * 24 * 60 * 60);

                console.log("Text settings applied:", family, size);
            } catch (error) {
                console.error('Error applying text settings:', error);
            }
        }

        function resetTextSettings() {
            try {
                const defaultFamily = "Arial, sans-serif";
                const defaultSize = "16px";

                if (fontFamily) fontFamily.value = defaultFamily;
                if (fontSize) fontSize.value = defaultSize;

                document.body.style.fontFamily = defaultFamily;
                document.body.style.fontSize = defaultSize;

                if (mainContent) {
                    mainContent.style.fontFamily = defaultFamily;
                    mainContent.style.fontSize = defaultSize;
                }

                localStorage.removeItem("fontFamily");
                localStorage.removeItem("fontSize");

                document.cookie = "fontFamily=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                document.cookie = "fontSize=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";

                console.log("Text settings reset to default");
            } catch (error) {
                console.error('Error resetting text settings:', error);
            }
        }

        function loadTextSettings() {
            try {
                let savedFamily = localStorage.getItem("fontFamily");
                let savedSize = localStorage.getItem("fontSize");

                if (!savedFamily) {
                    const cookieMatch = document.cookie.match(/fontFamily=([^;]+)/);
                    if (cookieMatch && cookieMatch[1]) {
                        savedFamily = cookieMatch[1];
                    }
                }

                if (!savedSize) {
                    const cookieMatch = document.cookie.match(/fontSize=([^;]+)/);
                    if (cookieMatch && cookieMatch[1]) {
                        savedSize = cookieMatch[1];
                    }
                }

                if (savedFamily) {
                    document.body.style.fontFamily = savedFamily;
                    if (mainContent) mainContent.style.fontFamily = savedFamily;
                    if (fontFamily) fontFamily.value = savedFamily;
                }

                if (savedSize) {
                    document.body.style.fontSize = savedSize;
                    if (mainContent) mainContent.style.fontSize = savedSize;
                    if (fontSize) fontSize.value = savedSize;
                }
            } catch (error) {
                console.error('Error loading text settings:', error);
            }
        }

        function toggleSidebar() {
            if (sidebar && mainContent && navbar) {
                const isHidden = sidebar.classList.toggle("hidden");
                mainContent.classList.toggle("full-width");
                navbar.classList.toggle("no-sidebar");
                navbar.classList.toggle("with-sidebar");
                localStorage.setItem("sidebarHidden", isHidden ? "true" : "false");
            }
        }

        if (toggleBtn) {
            toggleBtn.addEventListener("click", function () {
                const currentTheme = document.body.classList.contains("light-theme") ? "light" : "dark";
                const newTheme = currentTheme === "light" ? "dark" : "light";
                setTheme(newTheme);
            });
        }

        if (sidebarToggle) {
            sidebarToggle.addEventListener("click", toggleSidebar);
        }

        if (settingsToggle) {
            settingsToggle.addEventListener("click", toggleSettingsPanel);
        }

        if (closeSettings) {
            closeSettings.addEventListener("click", toggleSettingsPanel);
        }

        if (applySettings) {
            applySettings.addEventListener("click", applyTextSettings);
        }

        if (resetSettings) {
            resetSettings.addEventListener("click", resetTextSettings);
        }

        // Load all settings on page load
        try {
            const savedTheme = loadTheme();
            const sidebarHidden = localStorage.getItem("sidebarHidden") === "true";
            const settingsOpen = localStorage.getItem("settingsOpen") === "true";

            setTheme(savedTheme);
            loadTextSettings();

            // Apply sidebar state
            if (sidebarHidden && sidebar && mainContent && navbar) {
                sidebar.classList.add("hidden");
                mainContent.classList.add("full-width");
                navbar.classList.add("no-sidebar");
                navbar.classList.remove("with-sidebar");
            }

            // Apply settings panel state
            if (settingsOpen && settingsPanel) {
                settingsPanel.classList.add("open");
            }

            console.log("All settings loaded successfully");
        } catch (error) {
            console.error('Error loading settings:', error);
        }
    });
    </script>

</body>
</html>